{% extends 'coach/base.html' %}

{% block title %}Manage Passkeys - Verbal Coach{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Manage Passkeys</h1>
                    <p class="mt-1 text-sm text-gray-600">Manage your biometric authentication methods</p>
                </div>
                <a href="{% url 'coach:security_settings' %}" class="text-sm text-blue-600 hover:text-blue-500">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Security Settings
                </a>
            </div>

            <!-- Info Banner -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">About Passkeys</h3>
                        <p class="text-sm text-blue-700 mt-1">
                            Passkeys use your device's biometric authentication (fingerprint, Face ID, Windows Hello) or a hardware security key. 
                            They're more secure than passwords and can't be phished.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Register New Passkey -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-plus-circle text-purple-600 mr-2"></i>Register New Passkey
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Give your passkey a name (e.g., "MacBook Pro Touch ID", "Windows Hello", "YubiKey") and click Register.
                </p>
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <label for="passkey-name" class="block text-sm font-medium text-gray-700 mb-2">
                            Passkey Name
                        </label>
                        <input type="text" 
                               id="passkey-name" 
                               placeholder="e.g., MacBook Pro Touch ID"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <button type="button" 
                            onclick="registerPasskey()"
                            class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <i class="fas fa-fingerprint mr-2"></i>Register
                    </button>
                </div>
                <div id="registration-status" class="mt-4"></div>
            </div>

            <!-- Existing Passkeys -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-list mr-2"></i>Your Passkeys
                    </h3>
                </div>
                
                {% if passkeys %}
                <div class="divide-y divide-gray-200">
                    {% for passkey in passkeys %}
                    <div class="px-6 py-4 hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1">
                                <div class="flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                                        <i class="fas fa-fingerprint text-purple-600"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ passkey.name }}</div>
                                    <div class="text-sm text-gray-500">
                                        <span class="inline-flex items-center">
                                            <i class="fas fa-calendar mr-1"></i>
                                            Added {{ passkey.created_at|date:"M d, Y" }}
                                        </span>
                                        {% if passkey.last_used %}
                                        <span class="ml-4 inline-flex items-center">
                                            <i class="fas fa-clock mr-1"></i>
                                            Last used {{ passkey.last_used|date:"M d, Y H:i" }}
                                        </span>
                                        {% else %}
                                        <span class="ml-4 text-gray-400">
                                            <i class="fas fa-clock mr-1"></i>
                                            Never used
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <form method="post" action="{% url 'coach:delete_passkey' passkey.id %}" 
                                      onsubmit="return confirm('Are you sure you want to delete this passkey? You won\'t be able to use it for authentication anymore.');">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="px-3 py-1 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="px-6 py-8 text-center">
                    <i class="fas fa-fingerprint text-5xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">No passkeys registered yet.</p>
                    <p class="text-sm text-gray-400 mt-1">Register your first passkey above to get started.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
async function registerPasskey() {
    const nameInput = document.getElementById('passkey-name');
    const statusDiv = document.getElementById('registration-status');
    const name = nameInput.value.trim() || 'My Passkey';
    
    // Clear previous status
    statusDiv.innerHTML = '';
    
    try {
        // Show loading state
        statusDiv.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                    <span class="text-sm text-blue-700">Initiating passkey registration...</span>
                </div>
            </div>
        `;
        
        // Get registration options from server
        const optionsResponse = await fetch('{% url "coach:passkey_registration_begin" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        });
        
        const optionsData = await optionsResponse.json();
        
        if (!optionsResponse.ok || !optionsData.success) {
            const errorMsg = optionsData.error || 'Failed to get registration options';
            console.error('Registration error:', errorMsg);
            throw new Error(errorMsg);
        }
        
        // Convert challenge and user ID from base64
        const options = optionsData.options;
        options.challenge = base64ToArrayBuffer(options.challenge);
        options.user.id = base64ToArrayBuffer(options.user.id);
        
        // Update status
        statusDiv.innerHTML = `
            <div class="bg-purple-50 border border-purple-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-fingerprint fa-pulse text-purple-600 mr-2"></i>
                    <span class="text-sm text-purple-700">Please use your fingerprint, Face ID, or security key...</span>
                </div>
            </div>
        `;
        
        // Create credential
        const credential = await navigator.credentials.create({ publicKey: options });
        
        // Prepare credential data for server
        const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            type: credential.type,
            name: name,
            response: {
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                transports: credential.response.getTransports ? credential.response.getTransports() : []
            }
        };
        
        // Send credential to server
        const verifyResponse = await fetch('{% url "coach:passkey_registration_complete" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(credentialData),
        });
        
        const verifyData = await verifyResponse.json();
        
        if (verifyData.success) {
            statusDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-md p-3">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-sm text-green-700">Passkey registered successfully! Reloading...</span>
                    </div>
                </div>
            `;
            setTimeout(() => window.location.reload(), 1500);
        } else {
            throw new Error(verifyData.error || 'Failed to verify credential');
        }
        
    } catch (error) {
        console.error('Passkey registration error:', error);
        console.error('Error details:', error.stack);
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                    <div class="text-sm text-red-700">
                        <strong>Error:</strong> ${error.message}
                        <div class="mt-2 text-xs text-red-600">
                            Check the browser console (F12) for more details.
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Helper functions
function base64ToArrayBuffer(base64) {
    // Handle both standard base64 and base64url encoding
    // Replace base64url characters with base64 characters
    base64 = base64.replace(/-/g, '+').replace(/_/g, '/');
    
    // Pad with '=' if needed
    while (base64.length % 4 !== 0) {
        base64 += '=';
    }
    
    try {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    } catch (e) {
        console.error('Failed to decode base64:', base64, e);
        throw new Error('Invalid base64 string: ' + e.message);
    }
}

function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
