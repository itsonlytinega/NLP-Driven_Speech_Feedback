{% extends 'coach/drill_unified_base.html' %}
{% load static %}

{% block drill_content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="text-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Word Swap Whirlwind</h2>
        <p class="text-lg text-gray-600 mb-6">Spin the wheel to get filler words and replacements, then incorporate them into impromptu speech!</p>
    </div>

    <!-- Spinning Wheel -->
    <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Word Swap Wheel</h3>
        
        <div class="text-center">
            <!-- Wheel Container -->
            <div class="relative inline-block">
                <div id="spinning-wheel" class="w-64 h-64 rounded-full border-8 border-gray-300 relative overflow-hidden">
                    <!-- Wheel segments will be generated here -->
                </div>
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-red-500"></div>
            </div>
            
            <!-- Spin Button -->
            <div class="mt-6">
                <button id="spin-btn" onclick="spinWheel()" 
                        class="px-8 py-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold text-lg transition-colors">
                    üå™Ô∏è Spin the Wheel!
                </button>
            </div>
        </div>
        
        <!-- Current Selection -->
        <div id="current-selection" class="mt-6 hidden">
            <div class="bg-white rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Your Word Swap Challenge</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="text-center">
                        <div class="text-sm text-gray-600 mb-2">Filler Word</div>
                        <div id="selected-filler" class="text-2xl font-bold text-red-600 bg-red-100 px-4 py-2 rounded-lg">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-600 mb-2">Replacement</div>
                        <div id="selected-replacement" class="text-2xl font-bold text-green-600 bg-green-100 px-4 py-2 rounded-lg">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Speech Challenge -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Impromptu Speech Challenge</h3>
        
        <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
            <h4 class="text-lg font-bold text-blue-800 mb-3">Your Topic</h4>
            <div id="speech-topic" class="text-lg text-gray-700 leading-relaxed mb-4">
                {{ speech_topic }}
            </div>
            
            <!-- Challenge Instructions -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                <h5 class="font-semibold text-yellow-800 mb-2">Challenge Instructions:</h5>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>‚Ä¢ Speak for 1-2 minutes on the given topic</li>
                    <li>‚Ä¢ Avoid using the selected filler word</li>
                    <li>‚Ä¢ Use the replacement word naturally in your speech</li>
                    <li>‚Ä¢ Maintain smooth flow and confidence</li>
                </ul>
            </div>
            
            <!-- Topic Controls -->
            <div class="text-center mt-4 space-x-4">
                <button onclick="loadNewTopic()" 
                        class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors">
                    üéØ New Topic
                </button>
                <button onclick="startSpeechChallenge()" 
                        class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-colors">
                    üé§ Start Speech
                </button>
            </div>
        </div>
        
        <!-- Speech Timer -->
        <div id="speech-timer" class="hidden text-center mb-6">
            <div class="text-4xl font-bold text-blue-600 mb-2">02:00</div>
            <div class="text-lg text-gray-600">Time remaining</div>
        </div>
        
        <!-- Speech Status -->
        <div id="speech-status" class="text-center">
            <div class="text-lg font-semibold text-gray-600">Ready to start your impromptu speech!</div>
        </div>
    </div>

    <!-- Word Swap Practice -->
    <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Word Swap Practice</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Practice Sentences -->
            <div class="bg-white rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-3">Practice Sentences</h4>
                <div id="practice-sentences" class="space-y-3">
                    <!-- Practice sentences will be generated here -->
                </div>
                <div class="text-center mt-4">
                    <button onclick="generatePracticeSentences()" 
                            class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                        üîÑ New Practice
                    </button>
                </div>
            </div>
            
            <!-- Word Bank -->
            <div class="bg-white rounded-lg p-4">
                <h4 class="font-semibold text-gray-700 mb-3">Word Bank</h4>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <h5 class="text-sm font-semibold text-red-600 mb-2">Filler Words</h5>
                        <div class="space-y-1">
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">um</div>
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">uh</div>
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">like</div>
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">you know</div>
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">so</div>
                            <div class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm">well</div>
                        </div>
                    </div>
                    <div>
                        <h5 class="text-sm font-semibold text-green-600 mb-2">Replacements</h5>
                        <div class="space-y-1">
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">pause</div>
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">I think</div>
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">in other words</div>
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">therefore</div>
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">let me think</div>
                            <div class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">actually</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recording Section -->
    <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Speech Recording</h3>
        
        <div class="text-center">
            <button id="record-btn" onclick="startRecording()" 
                    class="px-8 py-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold text-lg transition-colors">
                üé§ Start Recording
            </button>
            <div id="recording-status" class="mt-4 text-lg font-semibold text-gray-600">Ready to record your word swap speech!</div>
        </div>
        
        <!-- Audio Player -->
        <div id="audio-player" class="mt-6 hidden">
            <audio controls class="w-full" id="whirlwind-audio">
                <source src="" type="audio/wav">
            </audio>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Performance Metrics</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-800">Filler Avoidance</div>
                <div id="filler-avoidance" class="text-3xl font-bold text-red-600">0%</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-800">Replacement Usage</div>
                <div id="replacement-usage" class="text-3xl font-bold text-green-600">0</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-800">Speech Flow</div>
                <div id="speech-flow" class="text-3xl font-bold text-blue-600">0/10</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-800">Overall Score</div>
                <div id="overall-score" class="text-3xl font-bold text-purple-600">0</div>
            </div>
        </div>
        
        <!-- Performance Tips -->
        <div class="mt-6 bg-gray-50 rounded-lg p-4">
            <h4 class="font-semibold text-gray-700 mb-2">Performance Tips</h4>
            <div id="performance-tips" class="text-sm text-gray-600">
                <p>Complete a speech challenge to see personalized tips!</p>
            </div>
        </div>
    </div>

    <!-- Feedback -->
    <div id="feedback-container" class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Whirlwind Feedback</h3>
        <div id="feedback-buttons"></div>
    </div>
</div>

<script>
// Drill-specific JavaScript
function getDrillSpecificParams() {
    // Override this function in individual drill templates if needed
    return {};
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/drills.js' %}"></script>
<script>
    let wheelSpinning = false;
    let currentFiller = '';
    let currentReplacement = '';
    let speechActive = false;
    let recordingActive = false;
    let speechTimer = null;
    let timeRemaining = 120; // 2 minutes

    const fillerWords = ['um', 'uh', 'like', 'you know', 'so', 'well', 'actually', 'basically'];
    const replacements = ['pause', 'I think', 'in other words', 'therefore', 'let me think', 'actually', 'specifically', 'essentially'];
    const topics = {{ speech_topics|safe }};

    function createWheel() {
        const wheel = document.getElementById('spinning-wheel');
        const totalSegments = fillerWords.length;
        const segmentAngle = 360 / totalSegments;
        
        wheel.innerHTML = '';
        
        fillerWords.forEach((word, index) => {
            const segment = document.createElement('div');
            segment.className = 'absolute w-full h-full';
            segment.style.transform = `rotate(${index * segmentAngle}deg)`;
            segment.style.clipPath = `polygon(50% 50%, 50% 0%, ${50 + 50 * Math.cos((index + 1) * segmentAngle * Math.PI / 180)}% ${50 + 50 * Math.sin((index + 1) * segmentAngle * Math.PI / 180)}%)`;
            
            const color = index % 2 === 0 ? 'bg-red-200' : 'bg-red-300';
            segment.innerHTML = `<div class="w-full h-full ${color} flex items-center justify-center text-xs font-semibold text-gray-800 transform -rotate-${index * segmentAngle}">${word}</div>`;
            
            wheel.appendChild(segment);
        });
    }

    function spinWheel() {
        if (wheelSpinning) return;
        
        wheelSpinning = true;
        document.getElementById('spin-btn').disabled = true;
        document.getElementById('spin-btn').textContent = 'Spinning...';
        
        const wheel = document.getElementById('spinning-wheel');
        const randomRotation = Math.random() * 3600 + 3600; // 10-20 full rotations
        const finalAngle = randomRotation % 360;
        
        wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
        wheel.style.transform = `rotate(${randomRotation}deg)`;
        
        setTimeout(() => {
            wheelSpinning = false;
            document.getElementById('spin-btn').disabled = false;
            document.getElementById('spin-btn').textContent = 'üå™Ô∏è Spin the Wheel!';
            
            // Determine selected word
            const segmentAngle = 360 / fillerWords.length;
            const selectedIndex = Math.floor((360 - finalAngle) / segmentAngle) % fillerWords.length;
            
            currentFiller = fillerWords[selectedIndex];
            currentReplacement = replacements[Math.floor(Math.random() * replacements.length)];
            
            showSelection();
        }, 3000);
    }

    function showSelection() {
        document.getElementById('selected-filler').textContent = currentFiller;
        document.getElementById('selected-replacement').textContent = currentReplacement;
        document.getElementById('current-selection').classList.remove('hidden');
        
        // Generate practice sentences
        generatePracticeSentences();
    }

    function generatePracticeSentences() {
        if (!currentFiller || !currentReplacement) return;
        
        const practiceSentences = [
            `Instead of saying "${currentFiller}, I think..." try "${currentReplacement}, I think..."`,
            `Replace "${currentFiller}" with a brief "${currentReplacement}" in your speech`,
            `Practice: "${currentReplacement}, the main point is..." instead of "${currentFiller}, the main point is..."`,
            `Use "${currentReplacement}" to gather your thoughts instead of "${currentFiller}"`
        ];
        
        const container = document.getElementById('practice-sentences');
        container.innerHTML = practiceSentences.map(sentence => 
            `<div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700">${sentence}</div>`
        ).join('');
    }

    function loadNewTopic() {
        const randomTopic = topics[Math.floor(Math.random() * topics.length)];
        document.getElementById('speech-topic').textContent = randomTopic;
    }

    function startSpeechChallenge() {
        if (!currentFiller || !currentReplacement) {
            alert('Please spin the wheel first to get your word swap challenge!');
            return;
        }
        
        speechActive = true;
        timeRemaining = 120;
        
        document.getElementById('speech-timer').classList.remove('hidden');
        document.getElementById('speech-status').textContent = `Speak about: ${document.getElementById('speech-topic').textContent}. Avoid "${currentFiller}" and use "${currentReplacement}"!`;
        
        startSpeechTimer();
    }

    function startSpeechTimer() {
        speechTimer = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                stopSpeechChallenge();
            }
        }, 1000);
    }

    function stopSpeechChallenge() {
        speechActive = false;
        clearInterval(speechTimer);
        
        document.getElementById('speech-timer').classList.add('hidden');
        document.getElementById('speech-status').textContent = 'Speech challenge complete!';
        
        // Analyze performance
        analyzePerformance();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.querySelector('#speech-timer .text-4xl').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function analyzePerformance() {
        // Simulate performance analysis
        const fillerAvoidance = Math.floor(Math.random() * 40) + 60; // 60-100%
        const replacementUsage = Math.floor(Math.random() * 5) + 1; // 1-5 uses
        const speechFlow = Math.floor(Math.random() * 4) + 6; // 6-10
        const overallScore = Math.round((fillerAvoidance + (replacementUsage * 10) + (speechFlow * 10)) / 3);
        
        document.getElementById('filler-avoidance').textContent = fillerAvoidance + '%';
        document.getElementById('replacement-usage').textContent = replacementUsage;
        document.getElementById('speech-flow').textContent = speechFlow + '/10';
        document.getElementById('overall-score').textContent = overallScore;
        
        // Generate performance tips
        generatePerformanceTips(fillerAvoidance, replacementUsage, speechFlow);
    }

    function generatePerformanceTips(fillerAvoidance, replacementUsage, speechFlow) {
        const tips = [];
        
        if (fillerAvoidance < 80) {
            tips.push('‚Ä¢ Focus more on avoiding filler words');
        }
        if (replacementUsage < 3) {
            tips.push('‚Ä¢ Try to use the replacement word more naturally');
        }
        if (speechFlow < 8) {
            tips.push('‚Ä¢ Work on maintaining smoother speech flow');
        }
        
        if (tips.length === 0) {
            tips.push('‚Ä¢ Excellent performance! Keep up the great work');
        }
        
        document.getElementById('performance-tips').innerHTML = tips.join('');
    }

    function startRecording() {
        if (recordingActive) return;
        
        recordingActive = true;
        document.getElementById('record-btn').textContent = 'Recording...';
        document.getElementById('record-btn').disabled = true;
        document.getElementById('recording-status').textContent = 'Recording your whirlwind speech...';
        
        drillComponents.startMic({
            onStart: function() {
                console.log('Whirlwind recording started');
            },
            onStop: function(audioBlob, audioUrl) {
                recordingActive = false;
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').disabled = false;
                document.getElementById('recording-status').textContent = 'Recording complete!';
                
                // Show audio playback
                const audioPlayer = document.getElementById('audio-player');
                const audio = document.getElementById('whirlwind-audio');
                audio.src = audioUrl;
                audioPlayer.classList.remove('hidden');
                
                // Show feedback buttons
                drillComponents.showFeedback('feedback-buttons', function(rating) {
                    console.log('Whirlwind feedback:', rating);
                });
            },
            onError: function(error) {
                alert('Error accessing microphone: ' + error.message);
                recordingActive = false;
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').disabled = false;
            }
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        createWheel();
        generatePracticeSentences();
    });
</script>
{% endblock %}
