{% extends "base.html" %}
{% load static %}

{% block title %}Record Voice - VerbalCoach{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0">ðŸŽ¤ Record Your Voice</h2>
                    <p class="mb-0 mt-2">Speak naturally for 30-60 seconds</p>
                </div>
                <div class="card-body p-5">
                    <!-- Recording Interface -->
                    <div id="recordingInterface" class="text-center">
                        <div class="mb-4">
                            <div class="recording-indicator mx-auto mb-3" style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-microphone" id="micIcon" style="font-size: 64px; color: white;"></i>
                            </div>
                            <div id="timer" class="h3 text-muted">00:00</div>
                            <div id="status" class="text-muted">Click to start recording</div>
                        </div>
                        
                        <div class="btn-group" role="group">
                            <button id="recordBtn" class="btn btn-lg btn-primary">
                                <i class="fas fa-circle mr-2"></i> Record
                            </button>
                            <button id="stopBtn" class="btn btn-lg btn-danger" disabled>
                                <i class="fas fa-stop mr-2"></i> Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Analysis Loading -->
                    <div id="analysisLoading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="sr-only">Analyzing...</span>
                        </div>
                        <h4>Analyzing your speech...</h4>
                        <p class="text-muted">This may take 30-60 seconds</p>
                    </div>
                    
                    <!-- Results -->
                    <div id="results" style="display: none;">
                        <div class="alert alert-success mb-4">
                            <h4><i class="fas fa-check-circle mr-2"></i> Analysis Complete!</h4>
                        </div>
                        
                        <!-- Score Cards -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <h5 class="text-muted">Filler Score</h5>
                                        <div id="fillerScore" class="display-4 font-weight-bold text-primary">-</div>
                                        <small class="text-muted" id="fillerTrend"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <h5 class="text-muted">Clarity Score</h5>
                                        <div id="clarityScore" class="display-4 font-weight-bold text-success">-</div>
                                        <small class="text-muted" id="clarityTrend"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <h5 class="text-muted">Pacing Score</h5>
                                        <div id="pacingScore" class="display-4 font-weight-bold text-info">-</div>
                                        <small class="text-muted" id="pacingTrend"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Growth Chart -->
                        <div class="mb-4">
                            <canvas id="growthChart" width="400" height="200"></canvas>
                        </div>
                        
                        <!-- Recommended Drill -->
                        <div class="alert alert-info" id="drillRecommendation">
                            <h5><i class="fas fa-graduation-cap mr-2"></i> Recommended Drill</h5>
                            <p id="drillName" class="mb-2"></p>
                            <a id="drillLink" href="#" class="btn btn-primary">
                                <i class="fas fa-play mr-2"></i> Start Drill
                            </a>
                        </div>
                        
                        <!-- New Recording Button -->
                        <div class="text-center mt-4">
                            <button onclick="resetRecording()" class="btn btn-outline-primary">
                                <i class="fas fa-microphone mr-2"></i> Record Again
                            </button>
                            <a href="{% url 'coach:dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-home mr-2"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .recording {
        animation: pulse 1s ease-in-out infinite;
    }
    
    #fillerScore, #clarityScore, #pacingScore {
        transition: all 0.5s ease;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let seconds = 0;
    let growthChart = null;
    
    // DOM elements
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const micIcon = document.getElementById('micIcon');
    const timer = document.getElementById('timer');
    const status = document.getElementById('status');
    const recordingInterface = document.getElementById('recordingInterface');
    const analysisLoading = document.getElementById('analysisLoading');
    const results = document.getElementById('results');
    
    // Start recording
    recordBtn.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                stream.getTracks().forEach(track => track.stop());
                sendAudioForAnalysis();
            };
            
            mediaRecorder.start();
            
            // UI updates
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            micIcon.classList.add('recording');
            status.textContent = 'Recording in progress...';
            
            // Start timer
            seconds = 0;
            recordingTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    });
    
    // Stop recording
    stopBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            clearInterval(recordingTimer);
            
            // UI updates
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            micIcon.classList.remove('recording');
            status.textContent = 'Processing...';
        }
    });
    
    // Send audio for analysis
    function sendAudioForAnalysis() {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const reader = new FileReader();
        
        reader.onload = async () => {
            const base64Audio = reader.result;
            
            // Show loading
            recordingInterface.style.display = 'none';
            analysisLoading.style.display = 'block';
            
            try {
                const formData = new FormData();
                formData.append('audio', base64Audio);
                formData.append('duration', seconds);
                
                const response = await fetch('{% url "coach:analyze_speech_api" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error analyzing speech: ' + error.message);
                resetRecording();
            }
        };
        
        reader.readAsDataURL(audioBlob);
    }
    
    // Display results
    function displayResults(data) {
        analysisLoading.style.display = 'none';
        results.style.display = 'block';
        
        const feedback = data.feedback;
        
        // Update scores
        document.getElementById('fillerScore').textContent = (feedback.filler_score * 100).toFixed(1);
        document.getElementById('clarityScore').textContent = (feedback.clarity_score * 100).toFixed(1);
        document.getElementById('pacingScore').textContent = (feedback.pacing_score * 100).toFixed(1);
        
        // Display drill recommendation
        if (data.drill.name) {
            document.getElementById('drillName').textContent = data.drill.name;
            document.getElementById('drillLink').href = data.drill.url;
        } else {
            document.getElementById('drillRecommendation').style.display = 'none';
        }
        
        // Create growth chart
        createGrowthChart(data.growth);
        
        // Celebrate improvement
        celebrateImprovement(data);
    }
    
    // Create growth chart
    function createGrowthChart(growthData) {
        const ctx = document.getElementById('growthChart').getContext('2d');
        
        if (growthChart) {
            growthChart.destroy();
        }
        
        growthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: growthData.dates,
                datasets: [
                    {
                        label: 'Filler Score',
                        data: growthData.filler_scores,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Clarity Score',
                        data: growthData.clarity_scores,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Pacing Score',
                        data: growthData.pacing_scores,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Your Speech Progress'
                    },
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });
    }
    
    // Celebrate improvement
    function celebrateImprovement(data) {
        // TODO: Add confetti animation
        console.log('Great job!');
    }
    
    // Reset recording interface
    function resetRecording() {
        recordingInterface.style.display = 'block';
        analysisLoading.style.display = 'none';
        results.style.display = 'none';
        timer.textContent = '00:00';
        status.textContent = 'Click to start recording';
        seconds = 0;
    }
</script>
{% endblock %}










