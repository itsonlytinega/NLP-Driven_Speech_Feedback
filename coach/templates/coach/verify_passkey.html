{% extends 'coach/base.html' %}

{% block title %}Verify Passkey - Verbal Coach{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <div class="mx-auto h-16 w-16 text-purple-600">
                <i class="fas fa-fingerprint text-5xl"></i>
            </div>
            <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                Verify with Passkey
            </h2>
            <p class="mt-2 text-sm text-gray-600">
                Use your biometric authentication to sign in
            </p>
        </div>
        
        <div class="bg-white shadow rounded-lg p-6">
            <div class="mb-6">
                <p class="text-sm text-gray-600 text-center">
                    Hello <strong>{{ user.first_name }}</strong>, please authenticate with your passkey.
                </p>
            </div>
            
            <div id="verification-status" class="mb-4"></div>
            
            <button type="button" 
                    onclick="verifyPasskey()"
                    class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition">
                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                    <i class="fas fa-fingerprint text-purple-500 group-hover:text-purple-400"></i>
                </span>
                Authenticate with Passkey
            </button>
            
            <div class="mt-6">
                <a href="{% url 'coach:choose_2fa_method' %}" class="text-center block text-sm text-gray-600 hover:text-gray-500">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Use a different method
                </a>
            </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>Tip:</strong> When prompted, use your device's fingerprint sensor, Face ID, Windows Hello, 
                        or security key to authenticate.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function verifyPasskey() {
    const statusDiv = document.getElementById('verification-status');
    
    // Clear previous status
    statusDiv.innerHTML = '';
    
    try {
        // Show loading state
        statusDiv.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                    <span class="text-sm text-blue-700">Preparing authentication...</span>
                </div>
            </div>
        `;
        
        // Get authentication options from server
        const optionsResponse = await fetch('{% url "coach:passkey_authentication_begin" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        });
        
        if (!optionsResponse.ok) {
            throw new Error('Failed to get authentication options');
        }
        
        const optionsData = await optionsResponse.json();
        if (!optionsData.success) {
            throw new Error(optionsData.error || 'Failed to get authentication options');
        }
        
        // Convert challenge from base64
        const options = optionsData.options;
        options.challenge = base64ToArrayBuffer(options.challenge);
        
        // Convert allowCredentials IDs from base64
        if (options.allowCredentials) {
            options.allowCredentials = options.allowCredentials.map(cred => ({
                ...cred,
                id: base64ToArrayBuffer(cred.id)
            }));
        }
        
        // Update status
        statusDiv.innerHTML = `
            <div class="bg-purple-50 border border-purple-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-fingerprint fa-pulse text-purple-600 mr-2"></i>
                    <span class="text-sm text-purple-700">Please use your fingerprint, Face ID, or security key...</span>
                </div>
            </div>
        `;
        
        // Get credential
        const credential = await navigator.credentials.get({ publicKey: options });
        
        // Prepare credential data for server
        const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            type: credential.type,
            response: {
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
                signature: arrayBufferToBase64(credential.response.signature),
                userHandle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null
            }
        };
        
        // Send credential to server
        const verifyResponse = await fetch('{% url "coach:passkey_authentication_complete" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(credentialData),
        });
        
        const verifyData = await verifyResponse.json();
        
        if (verifyData.success) {
            statusDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-md p-3">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-sm text-green-700">Authentication successful! Redirecting...</span>
                    </div>
                </div>
            `;
            setTimeout(() => window.location.href = verifyData.redirect_url, 1000);
        } else {
            throw new Error(verifyData.error || 'Authentication failed');
        }
        
    } catch (error) {
        console.error('Passkey authentication error:', error);
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-md p-3">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                    <span class="text-sm text-red-700">Error: ${error.message}</span>
                </div>
            </div>
        `;
    }
}

// Helper functions
function base64ToArrayBuffer(base64) {
    // Handle both standard base64 and base64url encoding
    // Replace base64url characters with base64 characters
    base64 = base64.replace(/-/g, '+').replace(/_/g, '/');
    
    // Pad with '=' if needed
    while (base64.length % 4 !== 0) {
        base64 += '=';
    }
    
    try {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    } catch (e) {
        console.error('Failed to decode base64:', base64, e);
        throw new Error('Invalid base64 string: ' + e.message);
    }
}

function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Automatically start verification when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Give user a moment to read the page, then auto-start
    setTimeout(() => verifyPasskey(), 1000);
});
</script>
{% endblock %}
